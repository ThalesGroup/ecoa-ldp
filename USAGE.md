# User's guide

This document describes how to use the LDP.

## Quick test after installation

```
cd $SOFTARC_HOME
# Move into an example ECOA workspace (or project):
cd Examples/Philosopher

# Generate the technical code from the XML models:
ant gen

# Compile all of the application's code (generated and manual):
ant exe

# This will create an executable file named 'a.out' in the current directory.

# Run the application:
./a.out

# The application runs and prints some stuff on the current terminal.
# Press Ctrl-C to interrupt execution and kill the application.
```

See also: [Examples/Philosopher/README.md]().

## Introduction to Ant

The LDP is basically a code generator, but includes additional functionnality such as:

* building (i.e. compiling and linking) an ECOA application, through the generation of makefiles and the call of the `make` tool,
* executing an ECOA application.

All these functions are performed through Ant. Ant is a generic build tool that offers powerful automation and cutomization possibilities.

In order to be used with the LDP, the root of an ECOA workspace shall contain a file `build.xml` with the following minimal contents:

```xml
<project>

  <property environment="env"/>
  <property file="local.properties"/> <!-- optional, ignored by git -->
  <property file="build.properties"/> <!-- optional, managed with git -->
  <!-- use ant library provided by SOFTARC -->
  <property name="softarc_home" location="${env.SOFTARC_HOME}"/>
  <import file="${softarc_home}/Ant/softarc.ant" /> <!-- to import predefined targets such as 'gen', 'exe', etc. >

</project>
```

The file `${softarc_home}/Ant/softarc.ant` defines many Ant "targets" that represent standard actions to be performed.

The files `local.properties` and `build.properties` contain Ant properties that configure the workspace. 
`build.properties` is destined to be shared under configuration management, whereas `local.properties` is 
temporary and user-specific.  In Ant, the redefinition of a property has no effect, so the first definition wins.
This allows `local.properties` to override anything.

`build.properties` typically contains the name of the default working deployment:

```
deploymentname=restaurant
```


In `build.xml`, the user may add his own project-specific targets, for example tests, calls to other tools, etc.


## Code generation

The LDP generates all the technical code of an application for a given ECOA deployment, through the following command:

```
ant gen
```

Or, if you want to specify a different deployment than the default:

```
ant gen -Ddeploymentname=D
```

The file `03-Deployments/D.deployment.xml` must exist, as well as all the other XML files that it refers to.

In case of error, the generation will stop an end with a `BUILD FAILED` message.
The names of all generated files is printed, with a status:

* `[ CREATED ]`: the file has been created (did not exist before)
* `[ UPDATED ]`: the file has been updated (modified) 
* `[IDENTICAL]`: the file has been regenerated but not modified (the timestamp is unchanged) 
* `[PRESERVED]`: the file has not been regenerated because it already exists and it is a manually-editable file 

All the technical code specific to this deployment is generated in the _generation directory_ (_gendir_):
`04-Integration/<deploymentname>`.

## Compiling and Linking an Application

In order to simplify things for the user, the LDP is capable of generating a makefile, and to call `make` to compile and link all the executables corresponding to a given ECOA deployment, through the following command:

```
ant exe            # build an executable from source code
```

The generated `makefile` is based on the following assumptions:

* All manual source code for components is found in `01-Components/CMP/IMPL/{src,inc}`.
* The whole application is only made of manual source code for components' code, plus the code generated by the LDP from the ECOA models
  of the application. 

Otherwise, the user is free to write his own makefile.

The makefile is (generated or not) is always located in the generation directory: `04-Integration/<deploymentname>/makefile`.

If this file does not exist, it will be generated; if it already exists, it will *not* be overwritten.

The output of the code compilation is a single executable file, in the same directory: `04-Integration/<deploymentname>/a.out`.

For convenience, this file is copied to the root of the ECOA workspace, by the makefile, at the end of the build process.


## Shortcut: all = gen + exes

The steps **gen** and **exe** can be combined in a single step **all**:

```
ant all
```

This supposes the 'deploymentname' property has been set.

## Running the application

The application is simply run as an ordinary program. The executable is named `a.out`:

```
./a.out
```

**Note**: The current directory must be writeable. 
Running the application creates Unix-domain sockets which appear as files in the current directory,
with names following the pattern `*.socket`.
These files are normally automatically removed when the application is terminated.

## Integrated console; scripting

When an application is executed, it has an integrated console that can be used to command and control the execution.

At startup, a text similar to the following is printed:

```
List of available commands:
  Wait <duration>     : wait for <duration> milliseconds
  Init     <component>
  Start    <component>
  Reset    <component>
  Stop     <component>
  Shutdown <component>
  Quit

<component> is the instance id, or '*' for all instances.
<component> may be omitted, meaning all instances.
Lines starting with '#' are ignored.

>>
```

The `>>` symbol is a prompt indicating that a command can be entered.

Components are identified by an instance id that is computed from the list of all component instances, as listed in the deployment
model (from 0 to N-1, N being the total number of instances).

This built-in shell available for every application allows to initialize and start components, and many other things.

The application can be terminated by the command `Quit` or entering Ctrl-C.


## Running though Ant

The execution of the application can also be started through Ant with the following target:

```
ant run
```

**Warning**: Ant bufferizes the standard output of the executed program, so when running through Ant, the output text of
the application may not appear immediately, compared to a direct execution.
Each line will also be prefixed by `     [exec] ` by Ant.

It is also possible to run the application through Ant with a script:

```
ant run_with -Dscript=my_script_file.txt
```


## Applications with several executables

The application may have sub-executables (elements `<executable>` defined in the deployment model).
In this case, for the LDP, the main process forks (i.e. replicates itself) as necessary.
Therefore, it is normal to have always a single executable file (`a.out`) for an application, even if at runtime
several executables (Linux processes) will be created. These processes are visible with the command `ps`, each with the same name `a.out`.
The parent process corresponds to the element `<application>` in the deployment model, and for each element `<executable>`, a child process is created with the `fork()` mechanism.

When the parent process (representing the application) is killed, all child processes are killed automatically.


## Logging

ECOA specifies a logging service, available to components for issuing text logs (functions Log_Trace, Log_Debug, Log_Warning, Raise_Error, Raise_Fatal_Error).

These logs are printed on the standard output of the running process.

The format is one line per log, formatted as follows:

```
#<instance_name>: <text>
```

Note: Presently, the level is not displayed.

Note: When several components produce logs simultaneously from several tasks or executables, the logs may be mixed up on the standard output.


## Ant extension points

It is possible to define, in the project's `build.xml` file, specific targets that will be run automatically, before, after, or between the
targets predefined by the LDP (such as 'gen', 'exe', etc.).

This allows the user to extend the build process and to automate any specific task, such as copying files, generating files, etc.

See `<extension-point>` elements in file `$SOFTARC_HOME/Ant/softarc.ant`, and refer to the Ant documentation, to use this mechanism.

